# Test du Workflow Automatis√© Complet
# Ce script teste l'approche 100% automatis√©e : Publish ‚Üí Harvest ‚Üí MSI

param(
    [string]$Version = "1.0.0.0",
    [string]$Platform = "x64",
    [string]$Configuration = "Release"
)

Write-Host "=== TEST WORKFLOW AUTOMATIS√â BUCKET ===" -ForegroundColor Green
Write-Host "üéØ Approche 100% automatis√©e : Publish ‚Üí Harvest ‚Üí MSI" -ForegroundColor Cyan
Write-Host ""
Write-Host "Param√®tres:" -ForegroundColor Yellow
Write-Host "  Version: $Version" -ForegroundColor White
Write-Host "  Platform: $Platform" -ForegroundColor White
Write-Host "  Configuration: $Configuration" -ForegroundColor White

# Mapping Platform ‚Üí RID
$ridMap = @{
    "x64" = "win-x64"
    "x86" = "win-x86"
    "ARM64" = "win-arm64"
}
$rid = $ridMap[$Platform]

Write-Host "`nüöÄ √âTAPE 1: Publish de l'application" -ForegroundColor Cyan
Write-Host "RID: $rid" -ForegroundColor Gray

# Publish avec tous les runtimes inclus
$publishArgs = @(
    "publish", "src\Bucket.App\Bucket.App.csproj"
    "-c", $Configuration
    "-r", $rid
    "-p:Platform=$Platform"
    "-p:Version=$Version"
    "-p:PublishSingleFile=false"
    "-p:SelfContained=true"
    "-p:PublishReadyToRun=false"
    "-p:PublishTrimmed=false"
    "--verbosity", "minimal"
)

Write-Host "Commande: dotnet $($publishArgs -join ' ')" -ForegroundColor Gray
dotnet @publishArgs

if ($LASTEXITCODE -ne 0) {
    Write-Host "‚ùå √âchec du publish" -ForegroundColor Red
    exit 1
}

# V√©rifier le r√©pertoire de publish
$publishPath = "src\Bucket.App\bin\$Platform\$Configuration\net9.0-windows10.0.26100\$rid\publish"
if (-not (Test-Path $publishPath)) {
    # Essayer le chemin alternatif
    $publishPath = "src\Bucket.App\bin\$Platform\$Configuration\net9.0-windows10.0.26100\$rid"
}

if (Test-Path $publishPath) {
    $files = Get-ChildItem -Path $publishPath -Recurse -File
    Write-Host "‚úÖ Publish r√©ussi!" -ForegroundColor Green
    Write-Host "üìÅ R√©pertoire: $publishPath" -ForegroundColor Cyan
    Write-Host "üìä Fichiers g√©n√©r√©s: $($files.Count)" -ForegroundColor Cyan

    # Analyse des types de fichiers
    $fileTypes = $files | Group-Object Extension | Sort-Object Count -Descending
    Write-Host "üìã Types de fichiers qui seront automatiquement harvest√©s:" -ForegroundColor Yellow
    $fileTypes | Select-Object -First 8 | ForEach-Object {
        $ext = if ($_.Name) { $_.Name } else { "(sans extension)" }
        Write-Host "   $ext : $($_.Count) fichier(s)" -ForegroundColor Gray
    }

    # Exemples de fichiers critiques
    Write-Host "üîç Fichiers critiques d√©tect√©s:" -ForegroundColor Yellow
    $criticalFiles = @("*.exe", "*.dll", "*.json", "*.config")
    foreach ($pattern in $criticalFiles) {
        $matching = $files | Where-Object { $_.Name -like $pattern } | Select-Object -First 3
        if ($matching) {
            Write-Host "   $pattern :" -ForegroundColor Gray
            $matching | ForEach-Object { Write-Host "     - $($_.Name)" -ForegroundColor DarkGray }
        }
    }
} else {
    Write-Host "‚ùå R√©pertoire de publish non trouv√©: $publishPath" -ForegroundColor Red
    exit 1
}

Write-Host "`nüî® √âTAPE 2: Build du setup WiX avec harvest automatique" -ForegroundColor Cyan

# Build WiX avec les nouvelles variables
$wixArgs = @(
    "build", "setup\Bucket.Setup\Bucket.Setup.wixproj"
    "-c", $Configuration
    "-p:Platform=$Platform"
    "-p:Version=$Version"
    "--verbosity", "normal"
)

Write-Host "Commande: dotnet $($wixArgs -join ' ')" -ForegroundColor Gray
dotnet @wixArgs

if ($LASTEXITCODE -eq 0) {
    Write-Host "‚úÖ Build WiX r√©ussi!" -ForegroundColor Green
} else {
    Write-Host "‚ùå √âchec du build WiX" -ForegroundColor Red

    # Afficher les logs d'erreur
    $logPath = "setup\Bucket.Setup\obj\$Platform\$Configuration"
    if (Test-Path $logPath) {
        Write-Host "üìã Logs de build:" -ForegroundColor Yellow
        Get-ChildItem $logPath -Recurse -Filter "*.log" -ErrorAction SilentlyContinue |
            Select-Object -First 2 | ForEach-Object {
            Write-Host "=== $($_.Name) ===" -ForegroundColor Yellow
            Get-Content $_.FullName -Tail 15 | ForEach-Object {
                Write-Host "  $_" -ForegroundColor Gray
            }
        }
    }
    exit 1
}

Write-Host "`nüì¶ √âTAPE 3: V√©rification du MSI g√©n√©r√©" -ForegroundColor Cyan

$expectedMsi = "artifacts\installers\Bucket-$Version-$Platform.msi"
if (Test-Path $expectedMsi) {
    $msiInfo = Get-Item $expectedMsi
    $sizeMB = [math]::Round($msiInfo.Length / 1MB, 2)

    Write-Host "‚úÖ MSI g√©n√©r√© avec succ√®s!" -ForegroundColor Green
    Write-Host "üìç Fichier: $expectedMsi" -ForegroundColor Cyan
    Write-Host "üìè Taille: $sizeMB MB" -ForegroundColor Cyan
    Write-Host "üïí Cr√©√©: $($msiInfo.CreationTime)" -ForegroundColor Cyan

    # Comparaison avec la taille du publish
    if (Test-Path $publishPath) {
        $publishSize = (Get-ChildItem $publishPath -Recurse -File | Measure-Object Length -Sum).Sum / 1MB
        $compressionRatio = [math]::Round((1 - ($sizeMB / $publishSize)) * 100, 1)
        Write-Host "üìä Compression: $([math]::Round($publishSize, 2)) MB ‚Üí $sizeMB MB ($compressionRatio% de r√©duction)" -ForegroundColor Cyan
    }
} else {
    Write-Host "‚ùå MSI non trouv√©: $expectedMsi" -ForegroundColor Red

    # Lister ce qui existe dans le r√©pertoire
    $installersDir = "artifacts\installers"
    if (Test-Path $installersDir) {
        Write-Host "üìÅ Contenu du r√©pertoire installers:" -ForegroundColor Yellow
        Get-ChildItem $installersDir | ForEach-Object {
            Write-Host "   - $($_.Name)" -ForegroundColor Gray
        }
    }
    exit 1
}

Write-Host "`nüéâ TEST TERMIN√â AVEC SUCC√àS!" -ForegroundColor Green
Write-Host ""
Write-Host "‚ú® R√©sum√© de l'automatisation:" -ForegroundColor Cyan
Write-Host "  ‚Ä¢ Publish: $($files.Count) fichiers collect√©s automatiquement" -ForegroundColor White
Write-Host "  ‚Ä¢ Harvest: Aucun fichier √† lister manuellement dans WiX" -ForegroundColor White
Write-Host "  ‚Ä¢ MSI: G√©n√©r√© automatiquement ($sizeMB MB)" -ForegroundColor White
Write-Host "  ‚Ä¢ Maintenance: Z√©ro intervention manuelle requise" -ForegroundColor White
Write-Host ""
Write-Host "üöÄ Votre setup est maintenant 100% automatis√©!" -ForegroundColor Green
