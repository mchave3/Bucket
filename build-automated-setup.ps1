# Script de Build Automatis√© - Publish + WiX Setup
# Ce script d√©montre l'approche 100% automatis√©e

param(
    [string]$Platform = "x64",
    [string]$Configuration = "Release",
    [string]$Version = "1.0.0.0"
)

Write-Host "=== BUILD AUTOMATIS√â BUCKET SETUP ===" -ForegroundColor Green
Write-Host "Platform: $Platform" -ForegroundColor Cyan
Write-Host "Configuration: $Configuration" -ForegroundColor Cyan
Write-Host "Version: $Version" -ForegroundColor Cyan

# √âtape 1: Publish de l'application
Write-Host "`nüöÄ √âtape 1: Publish de l'application..." -ForegroundColor Yellow

$publishPath = "..\..\src\Bucket.App"
$publishCommand = "dotnet publish `"$publishPath\Bucket.App.csproj`" -c $Configuration -p Platform=$Platform --self-contained true"

Write-Host "Commande: $publishCommand" -ForegroundColor Gray
try {
    Invoke-Expression $publishCommand
    Write-Host "‚úÖ Publish r√©ussi!" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Erreur lors du publish: $_" -ForegroundColor Red
    exit 1
}

# √âtape 2: V√©rifier le contenu du publish
Write-Host "`nüìÅ √âtape 2: V√©rification du contenu publi√©..." -ForegroundColor Yellow

$targetDir = "..\..\src\Bucket.App\bin\$Configuration\net6.0-windows10.0.17763.0\$Platform\publish\"
if (Test-Path $targetDir) {
    $files = Get-ChildItem $targetDir -Recurse | Where-Object { -not $_.PSIsContainer }
    Write-Host "‚úÖ R√©pertoire de publish trouv√©: $targetDir" -ForegroundColor Green
    Write-Host "üìä Nombre de fichiers d√©tect√©s: $($files.Count)" -ForegroundColor Cyan

    # Afficher quelques exemples de fichiers
    Write-Host "üìã Exemples de fichiers qui seront automatiquement inclus:" -ForegroundColor Cyan
    $files | Select-Object -First 10 | ForEach-Object {
        Write-Host "   - $($_.Name)" -ForegroundColor Gray
    }
    if ($files.Count -gt 10) {
        Write-Host "   ... et $($files.Count - 10) autres fichiers" -ForegroundColor Gray
    }
} else {
    Write-Host "‚ùå R√©pertoire de publish non trouv√©: $targetDir" -ForegroundColor Red
}

# √âtape 3: Build du setup WiX
Write-Host "`nüî® √âtape 3: Build du setup WiX..." -ForegroundColor Yellow

$wixCommand = "dotnet build Bucket.Setup.wixproj -c $Configuration -p Platform=$Platform -p Version=$Version"
Write-Host "Commande: $wixCommand" -ForegroundColor Gray

try {
    Invoke-Expression $wixCommand
    Write-Host "‚úÖ Build WiX r√©ussi!" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Erreur lors du build WiX: $_" -ForegroundColor Red
    exit 1
}

# √âtape 4: V√©rifier le r√©sultat
Write-Host "`nüì¶ √âtape 4: V√©rification de l'installeur..." -ForegroundColor Yellow

$installerPath = "..\..\artifacts\installers\Bucket-$Version-$Platform.msi"
if (Test-Path $installerPath) {
    $installerInfo = Get-Item $installerPath
    Write-Host "‚úÖ Installeur cr√©√© avec succ√®s!" -ForegroundColor Green
    Write-Host "üìç Emplacement: $installerPath" -ForegroundColor Cyan
    Write-Host "üìè Taille: $([math]::Round($installerInfo.Length / 1MB, 2)) MB" -ForegroundColor Cyan
    Write-Host "üïí Cr√©√© le: $($installerInfo.CreationTime)" -ForegroundColor Cyan
} else {
    Write-Host "‚ùå Installeur non trouv√©: $installerPath" -ForegroundColor Red
}

Write-Host "`nüéâ PROCESSUS TERMIN√â!" -ForegroundColor Green
Write-Host "‚ú® Avantages de cette approche automatis√©e:" -ForegroundColor Cyan
Write-Host "   ‚Ä¢ Aucun fichier √† lister manuellement dans WiX" -ForegroundColor White
Write-Host "   ‚Ä¢ Nouvelles d√©pendances automatiquement d√©tect√©es" -ForegroundColor White
Write-Host "   ‚Ä¢ Localisations automatiquement incluses" -ForegroundColor White
Write-Host "   ‚Ä¢ Runtime .NET automatiquement embarqu√©" -ForegroundColor White
Write-Host "   ‚Ä¢ Maintenance minimale du setup" -ForegroundColor White
