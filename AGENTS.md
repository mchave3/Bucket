# AGENTS.md (coding-agent guide)

This is a PowerShell module repo built with Sampler + Invoke-Build.
- Source lives in `source/`
- Tests live in `tests/`
- Generated build artifacts go in `output/` (do not hand-edit)

## Repo map

- Module manifest (authoring source): `source/Bucket.psd1`
- Root module stub (rebuilt/merged during build): `source/Bucket.psm1`
- Public functions (exported): `source/Public/*.ps1`
- Private helpers (internal): `source/Private/*.ps1`
- Localization: `source/en-US/`
- Build config: `build.yaml`
- Dependency manifests: `RequiredModules.psd1`, `Resolve-Dependency.psd1`

Tests:
- QA gates: `tests/QA/module.tests.ps1`
- Unit tests: `tests/Unit/Public/*.tests.ps1`, `tests/Unit/Private/*.tests.ps1`

## Editor/assistant rules found

- Cursor rules: none found (`.cursor/rules/**` and `.cursorrules` not present).
- Copilot rules: none found (`.github/copilot-instructions.md` not present).

If these appear later, follow them as higher-priority guidance.

## Runtime targets

- Module targets PowerShell 7+ (`PowerShellVersion = '7.0'` in `source/Bucket.psd1`).
- PSEdition is Core-only (`CompatiblePSEditions = @('Core')`).
- Runtime dependency: `PwshSpectreConsole` (declared in `source/Bucket.psd1` and `RequiredModules.psd1`).

## Build / lint / test (run from repo root)

### Prereqs

- Recommended shell: PowerShell 7+ (`pwsh`).
- Dependency restore uses `Resolve-Dependency.ps1` (configured for PSResourceGet in `Resolve-Dependency.psd1`).
- QA tests use `git diff` to enforce changelog updates.

### Restore dependencies (no build)

- `pwsh -NoProfile -File .\build.ps1 -ResolveDependency -Tasks noop`

Notes:
- Dependencies are typically saved under `output/RequiredModules/` and prepended to `PSModulePath` by `build.ps1`.
- `build.ps1` can auto-restore when dependencies are missing (`-AutoRestore`).

### List available build tasks

- `pwsh -NoProfile -File .\build.ps1 -Tasks ?`

### Common workflows (Sampler)

- Build + test (default workflow): `pwsh -NoProfile -File .\build.ps1`
- Build only: `pwsh -NoProfile -File .\build.ps1 -Tasks build`
- Test only: `pwsh -NoProfile -File .\build.ps1 -Tasks test`
- Pack: `pwsh -NoProfile -File .\build.ps1 -Tasks pack`

### Run a single test file (preferred)

Use the build pipeline so dependencies + `PSModulePath` match CI:

- `pwsh -NoProfile -File .\build.ps1 -Tasks test -PesterScript .\tests\Unit\Public\Get-Something.tests.ps1`

Notes:
- `-PesterScript` also has alias `-PesterPath` (future-proof for Pester v5+).
- You can pass multiple `-PesterScript` paths (array).

### Run tests directly with Pester (fast iteration)

This works if the module is already importable in your session:

- `pwsh -NoProfile -Command "Invoke-Pester -Path .\\tests\\Unit\\Public\\Get-Something.tests.ps1 -Output Detailed"`

Tag filtering (Pester 5 style):
- `pwsh -NoProfile -Command "Invoke-Pester -Path .\\tests -TagFilter helpQuality -ExcludeTagFilter FunctionalQuality"`

### Linting (PSScriptAnalyzer)

QA runs ScriptAnalyzer per-function via `tests/QA/module.tests.ps1`, but you can run it manually:

- `pwsh -NoProfile -Command "Invoke-ScriptAnalyzer -Path .\\source -Recurse"`

## Code style guidelines (PowerShell)

Follow existing patterns in `source/Public/Get-Something.ps1` and `source/Private/Get-PrivateFunction.ps1`.

### Layout and file rules

- One function per file; file name must match the function name.
- Public functions go in `source/Public/`; private helpers go in `source/Private/`.
- Do not hand-edit `output/**` (generated by build).
- Avoid editing `source/Bucket.psm1` directly unless you know the build merge rules.

### Naming

- Use approved `Verb-Noun` names.
- Parameters: PascalCase (`-PrivateData`).
- Local variables: meaningful; prefer lower camel-case (`$projectPath`).

### Advanced function shape

- Prefer advanced functions:
  - `function Verb-Noun { [CmdletBinding()] param(...) begin/process/end }`
- Use `SupportsShouldProcess = $true` for side-effecting commands.
- Support pipeline input when sensible (`ValueFromPipeline`, `ValueFromPipelineByPropertyName`).

### Comment-based help (required)

QA enforces help quality for every function:
- `.SYNOPSIS` present
- `.DESCRIPTION` present (length threshold enforced)
- At least one `.EXAMPLE`
- Every parameter has a descriptive `.PARAMETER` entry (length threshold enforced)

### Imports and dependencies

- Do not `Import-Module` inside function bodies unless unavoidable.
- Prefer declaring dependencies via `source/Bucket.psd1` / `RequiredModules.psd1`.
- Tests should `Import-Module` in `BeforeAll` and `Remove-Module` in `AfterAll`.

### Formatting

- 4-space indentation.
- Opening brace on the next line for `function`, `param`, `process`, etc.
- Prefer `Write-Verbose -Message '...'`; avoid `Write-Host` in module code.

### Types and output

- Prefer explicit parameter types (e.g. `[string]`).
- Add `[OutputType([type])]` when practical.
- Prefer outputting objects / `Write-Output` over `return`.

### Error handling

- Do not set `$ErrorActionPreference` globally.
- For catchable failures: use `-ErrorAction Stop` and `try { } catch { }`.
- Throw terminating errors for invalid user input (fail fast).

### Logging

- `Write-Verbose` for diagnostics, `Write-Warning` for recoverable issues.
- Avoid `Write-Host` (acceptable in build scripts).

## Testing conventions (Pester 5)

- Every function must have a unit test file:
  - Public: `tests/Unit/Public/<Function>.tests.ps1`
  - Private: `tests/Unit/Private/<Function>.tests.ps1` (use `InModuleScope`)
- Prefer one `Describe` per function with focused `Context`/`It` blocks.
- Use `Mock` + `Should -Invoke` to verify internal calls.
